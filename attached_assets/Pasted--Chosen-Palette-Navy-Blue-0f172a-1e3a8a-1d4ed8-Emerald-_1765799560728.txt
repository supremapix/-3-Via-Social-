<!-- Chosen Palette: Navy Blue (#0f172a, #1e3a8a, #1d4ed8), Emerald Green (#059669, #10b981), Slate (#f8fafc, #e2e8f0). -->
<!-- Application Structure Plan: Dashboard com 15 seções temáticas (1 a 6 dados estáticos/visuais e 7 a 15 ferramentas interativas Gemini). A estrutura é linear (SPA), mas o foco é a funcionalidade (Task-Oriented View) para o gestor resolver problemas práticos baseados na metodologia dos 12 Módulos. Esta organização prioriza a usabilidade e a aplicação prática do conhecimento sobre a leitura sequencial do relatório. -->
<!-- Visualization & Content Choices: Seções 1-6 utilizam visualizações estáticas (Barra, Donut, Radar via Chart.js; Pirâmide, Scatter via Plotly.js) para quantificar o risco e o benefício da gestão técnica (Goal: Compare/Inform). Seções 7-15 oferecem 9 ferramentas de IA (text-based) para aplicar a metodologia (Goal: Organize/Inform/Compare). NO SVG/Mermaid. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão Pública de Alta Performance | 3ª Via Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; width: 100%; max-width: 100%; height: 350px; margin: 0 auto; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 1.5rem; border-top: 4px solid #059669; }
        .hero-bg { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); }
        .timeline-line { position: absolute; left: 50%; transform: translateX(-50%); width: 4px; height: 100%; background-color: #e2e8f0; z-index: 0; }
        .step-circle { width: 3rem; height: 3rem; background-color: #059669; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 10; position: relative; border: 4px solid white; }
    </style>
</head>
<body class="text-slate-800">

    <header class="hero-bg text-white py-16 px-4 mb-12">
        <div class="max-w-6xl mx-auto text-center">
            <div class="inline-block px-4 py-1 mb-4 border border-emerald-400 rounded-full text-emerald-300 text-sm font-bold tracking-wider uppercase">
                Compliance & Governança Pública
            </div>
            <h1 class="text-4xl md:text-6xl font-extrabold mb-6 tracking-tight">
                Engenharia Territorial e <span class="text-emerald-400">Gestão Eficiente</span>
            </h1>
            <!-- CLAREZA DA MISSÃO: Plataforma de Consultoria e Formação Técnica Neutra -->
            <p class="text-lg md:text-xl text-slate-300 max-w-3xl mx-auto leading-relaxed">
                Plataforma de **Consultoria e Formação Técnica Neutra**. Não somos partido ou organização religiosa. Preparamos líderes municipais para Gestão de Alta Performance. Dados consolidados sobre o impacto da profissionalização administrativa. Da Lei Orgânica à Captação de Recursos, uma análise técnica da Jornada de 12 Meses para Municípios de Alta Performance.
            </p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 pb-20 space-y-16">

        <section>
            <div class="mb-8 border-l-4 border-blue-900 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">1. O Custo do Amadorismo vs. Gestão Técnica</h2>
                <p class="text-slate-600 mt-2">
                    A falta de formação técnica gera prejuízos incalculáveis. O comparativo abaixo demonstra a redução drástica de riscos jurídicos e fiscais quando a gestão adota a metodologia baseada na Lei de Responsabilidade Fiscal (LRF) e no Planeamento Estratégico.
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card">
                    <h3 class="text-xl font-bold mb-4 text-blue-900">Índice de Rejeição de Contas</h3>
                    <p class="text-sm text-slate-500 mb-4">Comparativo: Gestão Improvisada vs. Gestão Técnica (Baseado em rejeições de TC)</p>
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-bold mb-4 text-blue-900">Eficiência na Captação de Recursos</h3>
                    <p class="text-sm text-slate-500 mb-4">Volume de verbas travadas por falta dos 32 Planos Obrigatórios</p>
                    <div class="chart-container">
                        <canvas id="resourceChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="mb-8 border-l-4 border-emerald-600 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">2. Os 5 Pilares da Identidade Administrativa</h2>
                <p class="text-slate-600 mt-2">
                    O Módulo 01 estabelece o alicerce constitucional. Todo ato administrativo deve obedecer rigorosamente aos princípios do Art. 37 da Constituição Federal (LIMPE). Esta distribuição ponderada garante a blindagem jurídica do mandato.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="card lg:col-span-1 flex flex-col justify-center">
                    <div class="text-5xl font-extrabold text-emerald-600 mb-2">100%</div>
                    <div class="text-lg font-bold text-slate-900 mb-4">Conformidade Legal</div>
                    <p class="text-slate-600 text-sm">
                        A gestão ética não é opcional. A aplicação dos princípios LIMPE reduz em até 90% os processos por Improbidade Administrativa.
                    </p>
                    <ul class="mt-6 space-y-3">
                        <li class="flex items-center text-sm font-semibold text-slate-700"><span class="w-2 h-2 bg-blue-900 rounded-full mr-2"></span>Legalidade Estrita</li>
                        <li class="flex items-center text-sm font-semibold text-slate-700"><span class="w-2 h-2 bg-blue-700 rounded-full mr-2"></span>Impessoalidade</li>
                        <li class="flex items-center text-sm font-semibold text-slate-700"><span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span>Moralidade</li>
                        <li class="flex items-center text-sm font-semibold text-slate-700"><span class="w-2 h-2 bg-emerald-600 rounded-full mr-2"></span>Publicidade</li>
                        <li class="flex items-center text-sm font-semibold text-slate-700"><span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>Eficiência</li>
                    </ul>
                </div>
                <div class="card lg:col-span-2">
                    <h3 class="text-xl font-bold mb-4 text-blue-900">Distribuição de Foco: Princípios Constitucionais</h3>
                    <div class="chart-container">
                        <canvas id="limpeChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="mb-8 border-l-4 border-yellow-500 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">3. Arquitetura Jurídica e Legislativa</h2>
                <p class="text-slate-600 mt-2">
                    Abordada nos Módulos 02 e 03. A hierarquia das normas é vital para evitar inconstitucionalidade. O gráfico abaixo ilustra a base normativa que sustenta a segurança jurídica municipal, desde a Constituição até os Atos Administrativos.
                </p>
            </div>

            <div class="card w-full">
                <h3 class="text-xl font-bold mb-2 text-blue-900">Pirâmide de Kelsen Aplicada ao Município</h3>
                <div id="pyramidDiv" class="w-full h-[400px]"></div>
            </div>
        </section>

        <section>
            <div class="mb-8 border-l-4 border-blue-900 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">4. Diagnóstico de Maturidade Urbana</h2>
                <p class="text-slate-600 mt-2">
                    Comparativo entre uma "Cidade Improvisada" e uma "Cidade Inteligente" (Módulos 04, 05, 07 e 10). A aplicação dos 32 Planos Municipais e da Lei do Governo Digital expande a capacidade de entrega de serviços.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h3 class="text-xl font-bold mb-4 text-blue-900">Radar de Eficiência Municipal</h3>
                    <div class="chart-container">
                        <canvas id="radarCityChart"></canvas>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-emerald-500">
                        <h4 class="font-bold text-slate-900">Planeamento (Planos Setoriais)</h4>
                        <p class="text-sm text-slate-600 mt-1">O salto de 30% para 95% ocorre pela elaboração dos planos de Saneamento, Mobilidade e Diretor, destravando verbas federais.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-600">
                        <h4 class="font-bold text-slate-900">Tecnologia (Smart Cities)</h4>
                        <p class="text-sm text-slate-600 mt-1">Implementação de Governo Digital e conectividade, reduzindo custos operacionais da máquina pública.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500">
                        <h4 class="font-bold text-slate-900">Resiliência (Defesa Civil)</h4>
                        <p class="text-sm text-slate-600 mt-1">Mapeamento de riscos e protocolos de crise aumentam a capacidade de resposta a desastres climáticos.</p>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="mb-8 border-l-4 border-emerald-600 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">5. Ciclo Orçamentário e Financeiro (Módulo 06)</h2>
                <p class="text-slate-600 mt-2">
                    O fluxo do dinheiro público deve respeitar o rito constitucional. A quebra deste ciclo é a principal causa de inelegibilidade de gestores. Abaixo, o fluxo blindado de responsabilidade fiscal.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card bg-slate-50 border-t-blue-900">
                    <div class="text-4xl font-bold text-slate-200 mb-2">01</div>
                    <h3 class="text-lg font-bold text-blue-900">PPA (Plano Plurianual)</h3>
                    <p class="text-xs font-bold text-emerald-600 uppercase mb-2">Visão de 4 Anos</p>
                    <p class="text-sm text-slate-600">Define as diretrizes, objetivos e metas estratégicas de médio prazo. É o "Sonho Organizado".</p>
                </div>
                <div class="card bg-slate-50 border-t-blue-700">
                    <div class="text-4xl font-bold text-slate-200 mb-2">02</div>
                    <h3 class="text-lg font-bold text-blue-900">LDO (Diretrizes)</h3>
                    <p class="text-xs font-bold text-emerald-600 uppercase mb-2">Metas Anuais</p>
                    <p class="text-sm text-slate-600">Define as prioridades para o ano seguinte e sintoniza o PPA com a realidade fiscal. É o "Filtro".</p>
                </div>
                <div class="card bg-slate-50 border-t-emerald-500">
                    <div class="text-4xl font-bold text-slate-200 mb-2">03</div>
                    <h3 class="text-lg font-bold text-blue-900">LOA (Orçamento)</h3>
                    <p class="text-xs font-bold text-emerald-600 uppercase mb-2">Execução Financeira</p>
                    <p class="text-sm text-slate-600">Estima receitas e fixa despesas. É a autorização legislativa para gastar e investir. É a "Ação".</p>
                </div>
            </div>
        </section>

        <section>
            <div class="mb-8 border-l-4 border-yellow-500 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">6. Impacto Económico e Social (Módulos 08 e 09)</h2>
                <p class="text-slate-600 mt-2">
                    A correlação entre Liberdade Económica e Desenvolvimento Social. Dados projetados mostram que desburocratização gera aumento direto no IDH e na Arrecadação Própria.
                </p>
            </div>

            <div class="card w-full">
                <h3 class="text-xl font-bold mb-2 text-blue-900">Correlação: Desburocratização x Receita Própria</h3>
                <div id="scatterDiv" class="w-full h-[400px]"></div>
            </div>
        </section>

        <!-- SECÇÃO 7: SIMULADOR DE RISCO JURÍDICO (FEATURE 1) -->
        <section>
            <div class="mb-8 border-l-4 border-emerald-600 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">7. Simulador de Risco Jurídico ✨</h2>
                <p class="text-slate-600 mt-2">
                    Consulte o seu Auditor de Compliance virtual. Insira uma ação administrativa (ex: "Contratei uma empresa de limpeza por inexigibilidade") e receba uma avaliação de risco baseada na legislação atualizada.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-blue-900">
                <h3 class="text-xl font-bold mb-4 text-blue-900">Análise de Compliance</h3>
                
                <textarea id="riskQuery" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-4" placeholder="Descreva a ação administrativa que deseja avaliar (ex: Decidi não realizar a audiência pública da LDO no prazo)."></textarea>
                
                <button onclick="performRiskAnalysis()" id="analyzeButton" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Analisar Risco Jurídico ✨
                </button>

                <div id="riskResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Resultado da Análise:</h4>
                    <div id="resultContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="riskLoading" class="mt-6 text-center text-blue-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A consultar legislação e jurisprudência...
                </div>
            </div>
        </section>

        <!-- SECÇÃO 8: GERADOR DE PLANO DE AÇÃO (FEATURE 2) -->
        <section>
            <div class="mb-8 border-l-4 border-blue-900 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">8. Gerador de Plano de Ação Estratégico ✨</h2>
                <p class="text-slate-600 mt-2">
                    Transforme um objetivo de governo num plano de trabalho estruturado, alinhado à metodologia dos 12 módulos e à Engenharia Territorial.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-emerald-600">
                <h3 class="text-xl font-bold mb-4 text-emerald-600">Plano de Implementação Rápida</h3>
                
                <textarea id="planQuery" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Insira seu objetivo (ex: Implementar o Plano de Saneamento Básico)"></textarea>
                
                <button onclick="generateActionPlan()" id="planButton" class="w-full py-3 bg-blue-900 hover:bg-blue-800 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Plano Estratégico ✨
                </button>

                <div id="planResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Estrutura do Plano:</h4>
                    <div id="planContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="planLoading" class="mt-6 text-center text-blue-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A estruturar o Plano de Ação...
                </div>
            </div>
        </section>

        <!-- SECÇÃO 9: AUDITORIA DE PLANOS MUNICIPAIS (FEATURE 3) -->
        <section>
            <div class="mb-8 border-l-4 border-yellow-500 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">9. Auditoria de Planos Municipais (PNRS/PMSB) ✨</h2>
                <p class="text-slate-600 mt-2">
                    Verifique o status de conformidade dos Planos de Saneamento Básico (PMSB) e Resíduos Sólidos (PNRS) no seu município. Essencial para captação de recursos federais.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-yellow-500">
                <h3 class="text-xl font-bold mb-4 text-yellow-700">Conformidade e Riscos</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="cityAudit" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="Nome do Município (ex: Ouro Preto)"/>
                    <input type="text" id="stateAudit" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="Estado (UF - ex: MG)"/>
                </div>
                
                <button onclick="auditMunicipalPlans()" id="auditButton" class="w-full py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Verificar Status de Planos ✨
                </button>

                <div id="auditResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 id="auditTitle" class="font-bold text-slate-900 mb-2"></h4>
                    <div id="auditContent" class="text-slate-700 space-y-3"></div>
                </div>
                
                <div id="auditLoading" class="mt-6 text-center text-yellow-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A auditar conformidade legal...
                </div>
            </div>
        </section>

        <!-- SECÇÃO 10: GERADOR DE IDEIAS SUSTENTÁVEIS (FEATURE 4) -->
        <section>
            <div class="mb-8 border-l-4 border-emerald-600 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">10. Gerador de Ideias Sustentáveis (ODS) ✨</h2>
                <p class="text-slate-600 mt-2">
                    Gere propostas de projetos inovadores e alinhados aos Objetivos de Desenvolvimento Sustentável (ODS), focando em infraestrutura e captação de recursos.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-emerald-600">
                <h3 class="text-xl font-bold mb-4 text-emerald-600">Design de Projeto Rápido</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="challengeQuery" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Desafio do município (ex: Falta de água na zona rural)"/>
                    <select id="odsSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="ODS 6: Água Limpa e Saneamento">ODS 6: Água Limpa e Saneamento</option>
                        <option value="ODS 9: Indústria, Inovação e Infraestrutura">ODS 9: Indústria, Inovação e Infraestrutura</option>
                        <option value="ODS 11: Cidades e Comunidades Sustentáveis">ODS 11: Cidades e Comunidades Sustentáveis</option>
                        <option value="ODS 13: Ação Contra a Mudança Global do Clima">ODS 13: Ação Contra a Mudança Global do Clima</option>
                        <option value="ODS 17: Parcerias e Meios de Implementação">ODS 17: Parcerias e Meios de Implementação</option>
                    </select>
                </div>
                
                <button onclick="generateSustainebleIdea()" id="ideaButton" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Ideia de Projeto Sustentável ✨
                </button>

                <div id="ideaResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Proposta de Projeto:</h4>
                    <div id="ideaContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="ideaLoading" class="mt-6 text-center text-emerald-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A desenhar a proposta alinhada aos ODS...
                </div>
            </div>
        </section>
        
        <!-- SECÇÃO 11: ENGENHARIA DE LIDERANÇA TERRITORIAL (FEATURE 5) -->
        <section>
            <div class="mb-8 border-l-4 border-blue-900 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">11. Engenharia de Liderança Territorial ✨</h2>
                <p class="text-slate-600 mt-2">
                    A multiplicação de liderança é a chave da **Engenharia Territorial** (Módulo 11). Este organograma, que replica a estrutura **Núcleo > Célula > Pequeno Grupo**, garante que a visão da gestão chegue até à menor comunidade, usando a hierarquia para formação e prestação de contas. 
                </p>
            </div>

            <div class="card bg-slate-50 border-t-blue-900">
                <h3 class="text-xl font-bold mb-4 text-blue-900">Estrutura de Multiplicação 12x3</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="cityLeadership" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="Cacequi" placeholder="Município (ex: Cacequi)"/>
                    <input type="text" id="stateLeadership" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="RS" placeholder="Estado (ex: RS)"/>
                </div>
                
                <button onclick="generateLeadershipStructure()" id="leadershipButton" class="w-full py-3 bg-blue-900 hover:bg-blue-800 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Organograma e Responsabilidades ✨
                </button>

                <div id="leadershipResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Hierarquia e Matriz de Ação:</h4>
                    <div id="leadershipContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="leadershipLoading" class="mt-6 text-center text-blue-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A estruturar a Matriz de Liderança...
                </div>
            </div>
        </section>
        
        <!-- SECÇÃO 12: ASSISTENTE DE REDAÇÃO DE PROJETO DE LEI (FEATURE 6) -->
        <section>
            <div class="mb-8 border-l-4 border-emerald-600 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">12. Assistente de Redação de Projeto de Lei ✨</h2>
                <p class="text-slate-600 mt-2">
                    Crie rapidamente um Projecto de Lei (PL) base, incluindo Ementa, Art. 1º e Justificativa, conforme as exigências do processo legislativo municipal (Módulo 3). Ideal para transformar uma demanda comunitária em norma legal.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-emerald-600">
                <h3 class="text-xl font-bold mb-4 text-emerald-600">Minuta Legislativa Rápida</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="lawSubject" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Assunto (ex: Incentivo à Agricultura Familiar)"/>
                    <input type="text" id="lawEffect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Efeito da Lei (ex: Cria o Programa de Apoio ao Produtor)"/>
                </div>
                
                <button onclick="draftProjectLaw()" id="lawButton" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Minuta de Projeto de Lei ✨
                </button>

                <div id="lawResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Proposta de Lei:</h4>
                    <div id="lawContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="lawLoading" class="mt-6 text-center text-emerald-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A redigir a minuta legislativa...
                </div>
            </div>
        </section>

        <!-- SECÇÃO 13: ORÇAMENTO PARTICIPATIVO SIMPLIFICADO (FEATURE 7) -->
        <section>
            <div class="mb-8 border-l-4 border-blue-900 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">13. Orçamento Participativo Simplificado ✨</h2>
                <p class="text-slate-600 mt-2">
                    (Módulo 06 - Gestão Orçamentária) Transforme grandes metas de investimento em linhas orçamentárias concretas (PPA, LDO, LOA), facilitando a comunicação com a população e o controle fiscal.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-blue-900">
                <h3 class="text-xl font-bold mb-4 text-blue-900">De Meta à Linha Orçamentária</h3>
                
                <textarea id="budgetGoalQuery" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Meta de investimento (ex: Construir uma UPA no Bairro X e comprar 5 ônibus escolares)."></textarea>
                
                <button onclick="generateParticipatoryBudget()" id="budgetButton" class="w-full py-3 bg-blue-900 hover:bg-blue-800 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Estrutura Orçamentária ✨
                </button>

                <div id="budgetResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Quebra Orçamentária (PPA/LDO/LOA):</h4>
                    <div id="budgetContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="budgetLoading" class="mt-6 text-center text-blue-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A estruturar o Orçamento...
                </div>
            </div>
        </section>

        <!-- SECÇÃO 14: PROTOCOLO DE CRISE E RESILIÊNCIA (FEATURE 8) -->
        <section>
            <div class="mb-8 border-l-4 border-yellow-500 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">14. Protocolo de Crise e Resiliência ✨</h2>
                <p class="text-slate-600 mt-2">
                    (Módulo 10 - Defesa Civil) Gere minutas de comunicado oficial de crise. A comunicação rápida e estruturada é vital para a resiliência urbana e a credibilidade da gestão.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-yellow-500">
                <h3 class="text-xl font-bold mb-4 text-yellow-700">Minuta de Comunicação Oficial</h3>
                
                <textarea id="crisisScenarioQuery" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 mb-4" placeholder="Descreva o cenário de crise (ex: Chuvas fortes causaram deslizamentos em três bairros. Três famílias desalojadas)."></textarea>
                
                <button onclick="generateCrisisProtocol()" id="crisisButton" class="w-full py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Comunicado de Crise ✨
                </button>

                <div id="crisisResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Comunicação para a População:</h4>
                    <div id="crisisContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="crisisLoading" class="mt-6 text-center text-yellow-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A redigir o Protocolo de Comunicação...
                </div>
            </div>
        </section>

        <!-- SECÇÃO 15: NOVO - ASSISTENTE DE CONFORMIDADE E CERTIFICAÇÃO EMPRESARIAL (FEATURE 9) -->
        <section>
            <div class="mb-8 border-l-4 border-emerald-600 pl-4">
                <h2 class="text-3xl font-bold text-slate-900">15. Assistente de Conformidade Empresarial ✨</h2>
                <p class="text-slate-600 mt-2">
                    (Módulo 09 - Economia Local) Apoie parceiros locais, MEIs ou LTDA, a alcançar o *Compliance* (ESG, ISO, Segurança do Trabalho) necessário para certificações, parcerias B2G ou representação local da 3ª Via.
                </p>
            </div>

            <div class="card bg-slate-50 border-t-emerald-600">
                <h3 class="text-xl font-bold mb-4 text-emerald-600">Roteiro de Compliance para Parceiros</h3>
                
                <textarea id="complianceQuery" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-4" placeholder="Insira o desafio de conformidade (ex: Queremos ser um representante local LTDA, ou: Quero que minha MEI obtenha o selo ESG para fornecimento de material)."></textarea>
                
                <button onclick="generateComplianceReport()" id="complianceButton" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition flex items-center justify-center gap-2">
                    Gerar Relatório de Conformidade ✨
                </button>

                <div id="complianceResult" class="mt-6 p-4 bg-white border border-slate-200 rounded-lg hidden">
                    <h4 class="font-bold text-slate-900 mb-2">Resultado da Auditoria Simplificada:</h4>
                    <div id="complianceContent" class="text-slate-700 space-y-2"></div>
                </div>
                
                <div id="complianceLoading" class="mt-6 text-center text-emerald-700 hidden">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    A gerar o roteiro de certificação e parceria...
                </div>
            </div>
        </section>


    </main>

    <footer class="bg-slate-900 text-white py-12 border-t-8 border-emerald-600">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <h2 class="text-2xl font-bold mb-4">CFER-BRASIL & TERRA E FÉ</h2>
            <p class="text-slate-400 mb-8 max-w-2xl mx-auto">
                Consultoria em Gestão Pública e Formação de Lideranças. Habilitação Jurídica para contratos B2G.
                CNPJ: 62.162.691/0001-87
            </p>
            <!-- Alterado para 4 colunas em telas médias/grandes e alinhamento à esquerda -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 text-sm text-slate-300 text-left">
                <div>
                    <span class="block font-bold text-white mb-1">Sede Administrativa (MG)</span>
                    Rua Da Bahia 1148, Sala 1208<br>Belo Horizonte - MG
                </div>
                <div>
                    <span class="block font-bold text-white mb-1">Contacto Principal e Suporte</span>
                    <span class="font-bold text-emerald-400">WhatsApp:</span> <a href="https://wa.me/5551995347903" class="hover:text-white transition">51 99534-7903</a><br>
                    <span class="font-bold text-slate-300">Tel. Fixo:</span> (41) 9272-1004 (Comercial)
                    <p class="text-xs mt-2">
                        <span class="block font-bold text-white mb-1">E-mails de Atendimento:</span>
                        <a href="mailto:contato@terraefe.com.br" class="hover:text-yellow-400 transition">contato@terraefe.com.br</a><br>
                        <a href="mailto:contato@cfer-br.com.br" class="hover:text-yellow-400 transition">contato@cfer-br.com.br</a>
                    </p>
                </div>
                <div>
                    <span class="block font-bold text-white mb-1">Direção Estratégica Remota</span>
                    <span class="font-bold text-emerald-400">Local:</span> Porto Alegre - RS<br>
                    <span class="text-xs text-slate-400 mt-1 block">Engenharia Territorial e Governança.<br>Atendimento com agenda prévia.</span>
                </div>
                
                <!-- NOVO BLOCO: REDES SOCIAIS E PORTAIS (BANNERS) -->
                <div>
                    <span class="block font-bold text-white mb-3">Redes Sociais e Portais</span>
                    
                    <!-- Ícones de Redes Sociais (Usando SVG inline para evitar dependências) -->
                    <div class="flex space-x-4 mb-6">
                        <a href="https://facebook.com/3avia.social" target="_blank" class="text-white hover:text-blue-500 transition" title="Facebook">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.134-1.333h2.866v-3h-3.999c-3.13 0-4.001 2.05-4.001 4.172v1.828z"/></svg>
                        </a>
                        <a href="https://x.com/rumpel_joao" target="_blank" class="text-white hover:text-slate-400 transition" title="X">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.791-1.574 2.163-2.723-.951.556-2.001.956-3.124 1.18-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.79 6.095-4.007-.205-7.557-2.133-9.96-5.045-.417.707-.647 1.624-.647 2.578 0 1.78.917 3.353 2.502 4.295-.845-.024-1.638-.26-2.332-.641v.079c0 3.22 2.305 5.838 5.305 6.425-.572.155-1.17.214-1.78.214-.437 0-.859-.042-1.275-.121.841 2.62 3.27 4.505 6.131 4.552-2.261 1.834-5.06 2.935-8.125 2.935-.53 0-1.05-.034-1.57-.089 3.12 2.032 6.824 3.218 10.74 3.218 12.899 0 19.954-10.713 19.954-19.954 0-.322-.014-.64-.047-.954.814-.567 1.518-1.284 2.071-2.091z"/></svg>
                        </a>
                        <a href="https://instagram.com/3avia.social" target="_blank" class="text-white hover:text-pink-500 transition" title="Instagram">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.014 4.85.071 4.043.184 5.27.765 5.845 2.515.26.837.332 1.572.365 2.94v3.945c.033 1.368-.039 2.103-.365 2.94-.575 1.75-1.802 2.331-5.845 2.515-1.266.057-1.646.071-4.85.071-3.204 0-3.584-.014-4.85-.071-4.043-.184-5.27-.765-5.845-2.515-.26-.837-.332-1.572-.365-2.94V9.972c-.033-1.368.039-2.103.365-2.94.575-1.75 1.802-2.331 5.845-2.515 1.266-.057 1.646-.071 4.85-.071zm0-2.163c-3.265 0-3.673.015-4.949.071-4.408.192-6.79 1.164-7.838 4.218-.553 1.61-.63 2.658-.663 4.437V12c.033 1.779.11 2.827.663 4.437 1.048 3.054 3.43 4.026 7.838 4.218 1.276.056 1.684.071 4.949.071 3.265 0 3.673-.015 4.949-.071 4.408-.192 6.79-1.164 7.838-4.218.553-1.61.63-2.658.663-4.437V12c-.033-1.779-.11-2.827-.663-4.437-1.048-3.054-3.43-4.026-7.838-4.218-1.276-.056-1.684-.071-4.949-.071zm0 4.672c-3.13 0-5.672 2.542-5.672 5.672s2.542 5.672 5.672 5.672 5.672-2.542 5.672-5.672c0-3.13-2.542-5.672-5.672-5.672zm0 9.344c-2.096 0-3.792-1.696-3.792-3.792s1.696-3.792 3.792-3.792 3.792 1.696 3.792 3.792-1.696 3.792-3.792 3.792zm6.282-10.472c-.776 0-1.405.629-1.405 1.405s.629 1.405 1.405 1.405 1.405-.629 1.405-1.405-.629-1.405-1.405-1.405z"/></svg>
                        </a>
                        <a href="https://linkedin.com/in/joao.rumpel" target="_blank" class="text-white hover:text-blue-700 transition" title="LinkedIn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.381 1.11-2.5 2.48-2.5s2.48 1.119 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.992v16h4.992v-8.038c0-4.388 6.124-3.418 6.124 0v8.038h4.984v-9.69c0-5.606-4.99-6.075-8.125-3.167v-2.028z"/></svg>
                        </a>
                    </div>

                    <!-- Banner Concept (Stylized Links) -->
                    <span class="block font-bold text-white mb-2">Sites Oficiais:</span>
                    <a href="https://www.cfer-br.com.br" target="_blank" class="block w-full text-center py-2 mb-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-bold transition text-sm">
                        CFER-BR (Consultoria)
                    </a>
                    <a href="https://www.terraefe.com.br" target="_blank" class="block w-full text-center py-2 bg-blue-700 hover:bg-blue-600 rounded-lg text-white font-bold transition text-sm">
                        TERRA E FÉ (Formação)
                    </a>
                </div>
                <!-- FIM NOVO BLOCO -->
            </div>
            
            <!-- BLOCO LEGAL E DE PARCERIAS (EXISTENTE) -->
            <div class="mt-8 pt-6 border-t border-slate-700 text-xs text-slate-500 text-left">
                <p class="font-bold text-slate-300 mb-2 uppercase tracking-wider">Governança Digital e Compliance (Matriz Online)</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <a href="https://www.cfer-br.com.br" target="_blank" class="font-semibold text-emerald-400 hover:text-white transition">CFER-BR CNPJ: 62.162.691/0001-87</a>
                        <br><span class="text-slate-400">CNAE Principal: 70.20-4-00 (Consultoria)</span>
                    </div>
                    <div>
                        <a href="https://www.terraefe.com.br" target="_blank" class="font-semibold text-emerald-400 hover:text-white transition">TERRA E FÉ CNPJ: 61.229.136/0001-62</a>
                        <br><span class="text-slate-400">CNAE Principal: 85.99-6-99 (Ensino)</span>
                    </div>
                    <div>
                        <span class="block font-semibold text-white mb-1">Parceiros Operacionais:</span>
                        <a href="https://www.cora.com.br" target="_blank" class="hover:text-yellow-400 transition">Banco CORA PJ (Financeiro)</a> | 
                        <a href="mailto:juridico@3avia.social.br" class="hover:text-yellow-400 transition">YR (Assessoria Jurídica)</a>
                    </div>
                </div>
                
                <!-- NOVO BLOCO PIX E BANCO -->
                <div class="mt-6 pt-4 border-t border-slate-700">
                    <p class="font-bold text-white mb-3 uppercase tracking-wider text-sm">Informação Financeira (Transferências PIX)</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-300">
                        <div>
                            <span class="block font-bold text-emerald-400">PIX CFER-BR (62.162.691/0001-87):</span>
                            <span class="font-mono text-white">62162691000187</span> (Chave: CNPJ)
                        </div>
                        <div>
                            <span class="block font-bold text-emerald-400">PIX TERRA E FÉ (61.229.136/0001-62):</span>
                            <span class="font-mono text-white">61229136000162</span> (Chave: CNPJ)
                        </div>
                        <div class="md:col-span-2">
                            <span class="block font-bold text-white mt-2">Instituição Financeira:</span>
                            Banco Cora SCD S.A. (201) - Conta Digital PJ.
                        </div>
                    </div>
                </div>
                <!-- FIM NOVO BLOCO -->
            </div>
            <!-- FIM BLOCO LEGAL -->
            <div class="mt-8 text-xs text-slate-500 text-center">
                © 2025 Grupo 3ª Via Social. Todos os direitos reservados.
            </div>
        </div>
    </footer>

    <script>
        // Removida a declaração `const apiKey = "";` pois ela deve ser injetada pelo ambiente Canvas.

        // --- GENERALIZED ERROR HANDLER ---
        function handleApiError(response, contentDiv, functionName) {
            let errorMessage;
            if (response && response.status === 401) {
                errorMessage = `⚠️ Erro de Autenticação (401) na função ${functionName}. A chave API não está autorizada. Por favor, verifique a configuração de autenticação do ambiente.`;
                contentDiv.innerHTML = `<p class="text-red-500 font-bold">${errorMessage}</p>`;
            } else if (response && response.status === 429) {
                errorMessage = `⚠️ Erro de Cota (429) na função ${functionName}. Limite de requisições excedido. Tente novamente em alguns minutos.`;
                contentDiv.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
            } else if (response) {
                errorMessage = `❌ Erro HTTP (${response.status}) na função ${functionName}. O servidor não respondeu como esperado.`;
                // Tenta buscar o detalhe do erro se o corpo for JSON
                try {
                    response.json().then(data => {
                        if (data.error && data.error.message) {
                            contentDiv.innerHTML = `<p class="text-red-500">${errorMessage} Detalhe: ${data.error.message}</p>`;
                        } else {
                            contentDiv.innerHTML = `<p class="text-red-500">${errorMessage} Tente novamente mais tarde.</p>`;
                        }
                    }).catch(() => {
                        contentDiv.innerHTML = `<p class="text-red-500">${errorMessage} Tente novamente mais tarde.</p>`;
                    });
                    return;
                } catch (e) {
                    // Se não for JSON, apenas retorna o erro HTTP
                }
            } else {
                contentDiv.innerHTML = `<p class="text-red-500">❌ Erro de Rede: Não foi possível conectar ao servidor para ${functionName}.</p>`;
            }
        }


        async function fetchWithRetry(apiUrl, payload) {
            let response;
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000; 

            while (attempts < maxAttempts) {
                try {
                    // Utiliza o mecanismo de injeção automática de API key pelo ambiente Canvas
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response;
                    } else if (response.status === 429) {
                        attempts++;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else if (response.status === 401) {
                         // Stop immediately on 401, no retry needed
                        return response;
                    } else {
                        // For other non-429/401 errors (400, 500), retry once more, then throw
                        if (attempts < maxAttempts - 1) {
                            attempts++;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                        } else {
                            return response; // Return the error response to be handled by the caller
                        }
                    }
                } catch (error) {
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
            return response; // Should return the last response or null if all attempts failed
        }
        
        
        async function performRiskAnalysis() {
            const query = document.getElementById('riskQuery').value.trim();
            const resultDiv = document.getElementById('riskResult');
            const loadingDiv = document.getElementById('riskLoading');
            const contentDiv = document.getElementById('resultContent');
            const button = document.getElementById('analyzeButton');

            if (!query) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-emerald-600');
            button.classList.add('bg-slate-400');

            const systemPrompt = "Atue como um Auditor Sênior do Tribunal de Contas (TC) especializado em Direito Administrativo e Responsabilidade Fiscal (LRF). Analise a ação administrativa fornecida pelo usuário. Sua resposta DEVE ser estruturada e concisa, e deve conter TRÊS PARTES obrigatórias, formatadas em Markdown: 1. **RISCO** (Alto/Médio/Baixo). 2. **FUNDAMENTO LEGAL** (Cite a lei/artigo mais relevante: LRF, LIA, Lei 14.133/2021, etc., com base na consulta Google Search). 3. **RECOMENDAÇÃO** (Ação corretiva imediata). Responda sempre em Português.";

            const userQuery = `Avalie a seguinte ação administrativa no contexto municipal: "${query}"`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-emerald-600');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**RISCO**')) {
                            const riskLevel = line.split(':')[1].trim();
                            let colorClass = 'text-slate-700';
                            if (riskLevel.includes('Alto')) colorClass = 'text-red-600 font-extrabold';
                            else if (riskLevel.includes('Médio')) colorClass = 'text-yellow-600 font-bold';
                            else if (riskLevel.includes('Baixo')) colorClass = 'text-emerald-600 font-bold';
                            return `<p class="text-lg ${colorClass}">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**FUNDAMENTO LEGAL**')) {
                             return `<p class="font-semibold text-blue-900">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**RECOMENDAÇÃO**')) {
                             return `<p class="italic text-slate-600">${line.replace(/\*\*/g, '')}</p>`;
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível obter a análise jurídica. Tente reformular a sua questão.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Simulador de Risco");
            }
        }

        async function generateActionPlan() {
            const query = document.getElementById('planQuery').value.trim();
            const resultDiv = document.getElementById('planResult');
            const loadingDiv = document.getElementById('planLoading');
            const contentDiv = document.getElementById('planContent');
            const button = document.getElementById('planButton');

            if (!query) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-blue-900');
            button.classList.add('bg-slate-400');

            const systemPrompt = "Atue como um Consultor Estratégico em Engenharia Territorial da 3ª Via Social. Você deve transformar o objetivo do usuário em um plano de ação estruturado de 5 a 7 passos. O plano DEVE ser formatado em Markdown e conter TRÊS PARTES obrigatórias: 1. **MÓDULOS ENVOLVIDOS** (Liste os números dos módulos 1 a 12 que dão suporte legal/técnico). 2. **PASSO A PASSO** (Use uma lista numerada para descrever as ações, mencionando o aspecto legal, financeiro, ou técnico de cada passo). 3. **META DE CURTO PRAZO** (Defina um marco inicial para 30 dias). Responda sempre em Português.";

            const userQuery = `Gere um plano de ação estratégico para o seguinte objetivo: "${query}"`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-blue-900');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**MÓDULOS ENVOLVIDOS**')) {
                            return `<p class="font-bold text-emerald-600">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**PASSO A PASSO**')) {
                             return `<p class="font-semibold text-blue-900">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^\d+\./)) {
                             return `<p class="ml-4 text-sm">${line}</p>`; // Numbered list item
                        } else if (line.startsWith('**META DE CURTO PRAZO**')) {
                             return `<p class="italic font-medium text-slate-700 mt-2">${line.replace(/\*\*/g, '')}</p>`;
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível estruturar o Plano. Tente um objetivo diferente.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Gerador de Plano");
            }
        }

        async function auditMunicipalPlans() {
            const city = document.getElementById('cityAudit').value.trim();
            const state = document.getElementById('stateAudit').value.trim();
            const resultDiv = document.getElementById('auditResult');
            const loadingDiv = document.getElementById('auditLoading');
            const contentDiv = document.getElementById('auditContent');
            const titleDiv = document.getElementById('auditTitle');
            const button = document.getElementById('auditButton');

            if (!city || !state) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            titleDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-yellow-600');
            button.classList.add('bg-slate-400');

            // --- JSON SCHEMA DEFINITION ---
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    municipio: { "type": "STRING" },
                    populacao_estimada: { "type": "STRING", "description": "Estimativa populacional do município." },
                    status_planos: {
                        "type": "ARRAY",
                        "description": "Lista dos principais planos municipais obrigatórios.",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "plano": { "type": "STRING" }, 
                                "status_conformidade": { "type": "STRING", "description": "Status: Desatualizado, Em Vigência, Ausente ou Em Elaboração." }, 
                                "base_legal": { "type": "STRING", "description": "Lei federal ou estadual que o exige, ou o ano da última atualização encontrada." }
                            }
                        }
                    },
                    risco_financeiro_geral: { "type": "STRING", "description": "Avaliação do risco de perda de verbas federais (Alto/Médio/Baixo) devido à situação dos planos." }
                },
                "propertyOrdering": ["municipio", "populacao_estimada", "status_planos", "risco_financeiro_geral"]
            };
            
            const systemPrompt = "Atue como um Analista Sênior do Ministério do Desenvolvimento Regional. Use o Google Search para verificar o status de conformidade dos seguintes planos obrigatórios no município de até 100 mil habitantes, com foco nas leis federais: Plano Municipal de Saneamento Básico (PMSB) e Plano de Gestão Integrada de Resíduos Sólidos (PMGIRS). Retorne a análise exclusivamente no formato JSON, preenchendo o schema fornecido. Se a informação exata for incerta, use o status 'Informação Indisponível' e cite a legislação que o exige (Lei 11.445/07 para PMSB e Lei 12.305/10 para PMGIRS).";

            const userQuery = `Audite os planos PMSB e PMGIRS para o município: ${city}, ${state}. Inclua a população estimada do município.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-yellow-600');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                
                try {
                    // Assuming the API returns text that is a JSON string
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("Resposta da API vazia ou inválida.");
                    
                    const auditData = JSON.parse(jsonText);
                    
                    titleDiv.innerHTML = `Auditoria para ${auditData.municipio} (${auditData.populacao_estimada} Hab.)`;
                    
                    let contentHtml = `<p class="text-sm text-slate-600 mb-3"><strong>Risco de Bloqueio de Verbas:</strong> <span class="font-bold text-red-600">${auditData.risco_financeiro_geral}</span></p>`;
                    contentHtml += `<div class="space-y-4">`;

                    auditData.status_planos.forEach(plano => {
                        let statusColor = 'bg-green-100 text-green-800 border-green-400';
                        if (plano.status_conformidade.includes('Desatualizado') || plano.status_conformidade.includes('Ausente')) {
                            statusColor = 'bg-red-100 text-red-800 border-red-400';
                        } else if (plano.status_conformidade.includes('Elaboração') || plano.status_conformidade.includes('Indisponível')) {
                            statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-400';
                        }
                        
                        contentHtml += `
                            <div class="p-3 border rounded-lg ${statusColor}">
                                <p class="font-bold">${plano.plano}</p>
                                <p class="text-sm">Status: <strong>${plano.status_conformidade}</strong></p>
                                <p class="text-xs text-slate-600">Base/Última Ação: ${plano.base_legal}</p>
                            </div>
                        `;
                    });
                    
                    contentHtml += `</div>`;
                    contentDiv.innerHTML = contentHtml;

                } catch (e) {
                    console.error("Erro ao processar JSON:", e);
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível processar a auditoria. A base de dados pública pode estar indisponível.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Auditoria de Planos");
            }
        }

        async function generateSustainebleIdea() {
            const challenge = document.getElementById('challengeQuery').value.trim();
            const ods = document.getElementById('odsSelect').value;
            const resultDiv = document.getElementById('ideaResult');
            const loadingDiv = document.getElementById('ideaLoading');
            const contentDiv = document.getElementById('ideaContent');
            const button = document.getElementById('ideaButton');

            if (!challenge) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-emerald-600');
            button.classList.add('bg-slate-400');

            const systemPrompt = `Atue como um Especialista em Gestão de Projetos e Sustentabilidade (Agenda 2030). Seu objetivo é gerar uma proposta de projeto municipal inovador, com foco na captação de recursos. Sua resposta DEVE ser estruturada em Markdown e conter as seguintes TRÊS PARTES obrigatórias: 1. **NOME DO PROJETO** (Curto e impactante). 2. **ALINHAMENTO E ODS** (Explique como o projeto resolve o desafio e se alinha ao ODS selecionado). 3. **PROPOSTA DE AÇÃO E CAPTAÇÃO** (Sugira 3 passos concretos para a implementação e as possíveis fontes de financiamento - BNDES, Caixa, Fundos Federais, Parceria com a Iniciativa Privada). Responda sempre em Português.`;

            const userQuery = `Gere uma ideia de projeto para resolver o seguinte desafio municipal: "${challenge}". O projeto deve ser focado no alinhamento ao ${ods}.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-emerald-600');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**NOME DO PROJETO**')) {
                            return `<p class="text-xl font-bold text-blue-900 mt-2">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**ALINHAMENTO E ODS**')) {
                             return `<p class="font-semibold text-emerald-600 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**PROPOSTA DE AÇÃO E CAPTAÇÃO**')) {
                             return `<p class="font-semibold text-blue-900 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^- /)) {
                            return `<ul class="list-disc ml-6 text-sm">${line.replace(/^- /, '<li>')}</li></ul>`; 
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível gerar a ideia de projeto. Tente reformular o desafio.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Gerador Sustentável");
            }
        }
        
        async function generateLeadershipStructure() {
            const city = document.getElementById('cityLeadership').value.trim();
            const state = document.getElementById('stateLeadership').value.trim();
            const resultDiv = document.getElementById('leadershipResult');
            const loadingDiv = document.getElementById('leadershipLoading');
            const contentDiv = document.getElementById('leadershipContent');
            const button = document.getElementById('leadershipButton');

            if (!city || !state) {
                resultDiv.classList.add('hidden');
                return;
            }
            
            // Definição do território com o município e estado
            const territory = `${city}, ${state}`;

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-blue-900');
            button.classList.add('bg-slate-400');

            const systemPrompt = `Atue como um Especialista em Organização Comunitária e Engenharia Territorial, aplicando a metodologia de multiplicação de liderança 'Núcleo Municipal > Célula de Bairro > Pequeno Grupo em Vila' (Módulo 11 da 3ª Via). Sua resposta DEVE ser um organograma de 3 níveis hierárquicos com as responsabilidades detalhadas de cada nível, usando o município fornecido como contexto para a descrição. Use Markdown e TRÊS PARTES obrigatórias: 1. **ORGANOGRAMA TERRITORIAL** (Descreva a hierarquia em 3 níveis com o exemplo fornecido: Núcleo Municipal de ${city}/${state} > Líderes de Células (Bairros) > Líderes de Pequenos Grupos (Vilas/Ruas)). 2. **MATRIZ DE RESPONSABILIDADES** (Descreva a responsabilidade principal para cada nível: Núcleo, Célula e Pequeno Grupo). 3. **MÉTRICA DE SUCESSO** (Como medir a eficácia da multiplicação, com foco em 3 indicadores). Responda sempre em Português.`;

            const userQuery = `Gere a estrutura de multiplicação de liderança para o município de ${territory}.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-blue-900');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**ORGANOGRAMA TERRITORIAL**')) {
                            return `<p class="font-bold text-blue-900">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**MATRIZ DE RESPONSABILIDADES**')) {
                             return `<p class="font-semibold text-emerald-600 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**MÉTRICA DE SUCESSO**')) {
                             return `<p class="font-semibold text-yellow-700 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^- /)) {
                            return `<ul class="list-disc ml-6 text-sm">${line.replace(/^- /, '<li>')}</li></ul>`; 
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível gerar a estrutura de liderança. Tente novamente.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Engenharia de Liderança");
            }
        }
        
        async function draftProjectLaw() {
            const subject = document.getElementById('lawSubject').value.trim();
            const effect = document.getElementById('lawEffect').value.trim();
            const resultDiv = document.getElementById('lawResult');
            const loadingDiv = document.getElementById('lawLoading');
            const contentDiv = document.getElementById('lawContent');
            const button = document.getElementById('lawButton');

            if (!subject || !effect) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-emerald-600');
            button.classList.add('bg-slate-400');

            const systemPrompt = "Atue como um Redator Legislativo Municipal, aplicando as regras de técnica legislativa (Ementa, Articulado e Justificativa). Você deve gerar uma minuta base de Projeto de Lei. Sua resposta DEVE ser estruturada em Markdown com TRÊS PARTES obrigatórias: 1. **EMENTA** (Curta, descrevendo o assunto). 2. **ARTICULADO BÁSICO** (Estrutura mínima com Art. 1º, Art. 2º e Art. 3º, usando linguagem legal formal). 3. **JUSTIFICATIVA** (Texto breve e persuasivo, citando a importância pública e social da medida). Responda sempre em Português.";

            const userQuery = `Redija um Projeto de Lei sobre o assunto "${subject}", com o seguinte efeito principal: "${effect}".`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-emerald-600');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**EMENTA**')) {
                            return `<p class="text-lg font-bold text-blue-900 mt-2">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**ARTICULADO BÁSICO**')) {
                             return `<p class="font-semibold text-emerald-600 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**JUSTIFICATIVA**')) {
                             return `<p class="font-semibold text-yellow-700 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^Art\. \d+º/)) {
                            return `<p class="font-mono text-sm ml-4">${line}</p>`; 
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível gerar o Projecto de Lei. Tente reformular o assunto.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Assistente Legislativo");
            }
        }
        
        async function generateParticipatoryBudget() {
            const query = document.getElementById('budgetGoalQuery').value.trim();
            const resultDiv = document.getElementById('budgetResult');
            const loadingDiv = document.getElementById('budgetLoading');
            const contentDiv = document.getElementById('budgetContent');
            const button = document.getElementById('budgetButton');

            if (!query) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-blue-900');
            button.classList.add('bg-slate-400');

            const systemPrompt = "Atue como um Técnico de Planejamento e Orçamento Público (PPA/LDO/LOA). Analise a meta de investimento fornecida. Sua resposta DEVE ser estruturada em Markdown com TRÊS PARTES obrigatórias: 1. **ALINHAMENTO PPA** (Qual o objetivo de médio prazo deve suportar esta meta - Módulo 06). 2. **DESDOBRAMENTO ORÇAMENTÁRIO** (Liste as 3 sub-ações que devem ser detalhadas na LDO/LOA: ex: Despesa de Capital, Despesa Corrente). 3. **COMUNICAÇÃO PÚBLICA** (Sugira uma frase para apresentar a meta à população de forma transparente e participativa). Responda sempre em Português.";

            const userQuery = `Gere a quebra orçamentária e de comunicação para a meta de investimento: "${query}"`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-blue-900');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**ALINHAMENTO PPA**')) {
                            return `<p class="font-bold text-blue-900 mt-2">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**DESDOBRAMENTO ORÇAMENTÁRIO**')) {
                             return `<p class="font-semibold text-emerald-600 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**COMUNICAÇÃO PÚBLICA**')) {
                             return `<p class="italic font-medium text-yellow-700 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^- /)) {
                            return `<ul class="list-disc ml-6 text-sm">${line.replace(/^- /, '<li>')}</li></ul>`; 
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível gerar a estrutura orçamentária. Verifique a meta.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Orçamento Participativo");
            }
        }
        
        async function generateCrisisProtocol() {
            const query = document.getElementById('crisisScenarioQuery').value.trim();
            const resultDiv = document.getElementById('crisisResult');
            const loadingDiv = document.getElementById('crisisLoading');
            const contentDiv = document.getElementById('crisisContent');
            const button = document.getElementById('crisisButton');

            if (!query) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-yellow-600');
            button.classList.add('bg-slate-400');

            const systemPrompt = "Atue como o Chefe de Comunicação da Defesa Civil Municipal, aplicando o protocolo de resposta a crises (Módulo 10). Gere uma minuta de comunicado oficial concisa e objetiva. Sua resposta DEVE ser estruturada em Markdown com TRÊS PARTES obrigatórias: 1. **TÍTULO E URGÊNCIA** (Ex: URGENCE | SITUAÇÃO DE ALERTA). 2. **AÇÃO EM CURSO** (O que a Prefeitura está fazendo: Defesa Civil, Equipes, etc.). 3. **INSTRUÇÕES À POPULAÇÃO** (3 instruções claras e curtas do que a população deve fazer). Responda sempre em Português.";

            const userQuery = `Gere um comunicado oficial de crise para o seguinte cenário: "${query}"`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-yellow-600');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**TÍTULO E URGÊNCIA**')) {
                            return `<p class="text-xl font-bold text-red-600 mt-2">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**AÇÃO EM CURSO**')) {
                             return `<p class="font-semibold text-blue-900 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**INSTRUÇÕES À POPULAÇÃO**')) {
                             return `<p class="font-semibold text-yellow-700 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^- /)) {
                            return `<ul class="list-disc ml-6 text-sm">${line.replace(/^- /, '<li>')}</li></ul>`; 
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível gerar o comunicado de crise. Tente novamente.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Protocolo de Crise");
            }
        }
        
        // --- NEW FEATURE 9 (REPLACEMENT): COMPLIANCE REPORT ---
        async function generateComplianceReport() {
            const query = document.getElementById('complianceQuery').value.trim();
            const resultDiv = document.getElementById('complianceResult');
            const loadingDiv = document.getElementById('complianceLoading');
            const contentDiv = document.getElementById('complianceContent');
            const button = document.getElementById('complianceButton');

            if (!query) {
                resultDiv.classList.add('hidden');
                return;
            }

            loadingDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            contentDiv.innerHTML = '';
            button.disabled = true;
            button.classList.remove('bg-emerald-600');
            button.classList.add('bg-slate-400');

            const systemPrompt = "Atue como um Auditor de Compliance e Certificação para Pequenas Empresas e MEIs no Brasil, com foco em parcerias B2G. Analise o pedido do usuário e gere um roteiro de conformidade. Sua resposta DEVE ser estruturada em Markdown com TRÊS PARTES obrigatórias: 1. **FOCO E TIPO DE NEGÓCIO** (Identificação do regime tributário e setor com base na consulta). 2. **CHECKLIST DE CONFORMIDADE** (3 a 5 requisitos práticos e legais para a certificação/norma mencionada: ISO, ESG, ou Segurança do Trabalho). 3. **OPORTUNIDADE 3ª VIA** (Como a parceria local da 3ª Via Social, via núcleo de líderes, pode ajudar o empreendedor a cumprir estes requisitos, conectando com o Módulo 11). Responda sempre em Português de Portugal.";

            const userQuery = `Pedido de conformidade: "${query}"`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            try {
                response = await fetchWithRetry(apiUrl, payload);
            } catch (error) {
                response = null;
            }

            loadingDiv.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('bg-slate-400');
            button.classList.add('bg-emerald-600');
            resultDiv.classList.remove('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const htmlContent = text.split('\n').map(line => {
                        if (line.startsWith('**FOCO E TIPO DE NEGÓCIO**')) {
                            return `<p class="font-bold text-blue-900 mt-2">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**CHECKLIST DE CONFORMIDADE**')) {
                             return `<p class="font-semibold text-emerald-600 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.startsWith('**OPORTUNIDADE 3ª VIA**')) {
                             return `<p class="font-semibold text-yellow-700 mt-3">${line.replace(/\*\*/g, '')}</p>`;
                        } else if (line.match(/^- /)) {
                            return `<ul class="list-disc ml-6 text-sm">${line.replace(/^- /, '<li>')}</li></ul>`; 
                        } else {
                            return `<p>${line}</p>`;
                        }
                    }).join('');
                    
                    contentDiv.innerHTML = htmlContent;

                } else {
                    contentDiv.innerHTML = '<p class="text-red-500">Erro: Não foi possível gerar o relatório de conformidade. Tente reformular o pedido.</p>';
                }

            } else {
                handleApiError(response, contentDiv, "Assistente de Conformidade");
            }
        }
        // --- END NEW FEATURE 9 (REPLACEMENT) ---


        // --- UTILITY: WRAP LABELS ---
        function wrapLabel(label) {
            const maxLength = 16;
            if (label.length <= maxLength) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                if ((currentLine + " " + words[i]).length <= maxLength) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // --- GLOBAL CHART CONFIG ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#475569';
        const tooltipPlugin = {
            tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                padding: 12,
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                callbacks: {
                    title: function(tooltipItems) {
                        const item = tooltipItems[0];
                        let label = item.chart.data.labels[item.dataIndex];
                        if (Array.isArray(label)) {
                            return label.join(' ');
                        } else {
                            return label;
                        }
                    }
                }
            }
        };

        // --- CHART 1: RISK REDUCTION (BAR) ---
        const ctxRisk = document.getElementById('riskChart').getContext('2d');
        new Chart(ctxRisk, {
            type: 'bar',
            data: {
                labels: ['Gestão Improvisada', 'Gestão Técnica'],
                datasets: [{
                    label: 'Risco de Rejeição de Contas (%)',
                    data: [78, 5],
                    backgroundColor: ['#ef4444', '#059669'],
                    borderRadius: 6,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    ...tooltipPlugin
                },
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Probabilidade de Rejeição (%)' } }
                }
            }
        });

        // --- CHART 2: RESOURCE CAPTURE (BAR) ---
        const ctxRes = document.getElementById('resourceChart').getContext('2d');
        new Chart(ctxRes, {
            type: 'bar',
            data: {
                labels: wrapLabel('Sem Planos Obrigatórios').concat(wrapLabel('Com Planos Aprovados')),
                datasets: [{
                    label: 'Recursos Federais Acessíveis (R$ Milhões)',
                    data: [2.5, 45.0],
                    backgroundColor: ['#94a3b8', '#1d4ed8'],
                    borderRadius: 6,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    ...tooltipPlugin
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Potencial de Captação (R$ Mi)' } }
                }
            }
        });

        // --- CHART 3: LIMPE PRINCIPLES (DOUGHNUT) ---
        const ctxLimpe = document.getElementById('limpeChart').getContext('2d');
        new Chart(ctxLimpe, {
            type: 'doughnut',
            data: {
                labels: ['Legalidade', 'Impessoalidade', 'Moralidade', 'Publicidade', 'Eficiência'],
                datasets: [{
                    data: [20, 20, 20, 20, 20],
                    backgroundColor: ['#1e3a8a', '#1d4ed8', '#059669', '#10b981', '#eab308'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    ...tooltipPlugin
                }
            }
        });

        // --- CHART 4: RADAR CITY MATURITY ---
        const ctxRadar = document.getElementById('radarCityChart').getContext('2d');
        new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: ['Planeamento', 'Saneamento', 'Tecnologia', 'Transparência', 'Mobilidade', 'Defesa Civil'],
                datasets: [{
                    label: 'Cidade Tradicional',
                    data: [30, 40, 20, 50, 35, 25],
                    backgroundColor: 'rgba(148, 163, 184, 0.2)',
                    borderColor: '#94a3b8',
                    pointBackgroundColor: '#94a3b8'
                }, {
                    label: 'Cidade 3ª Via (Técnica)',
                    data: [95, 90, 85, 100, 80, 90],
                    backgroundColor: 'rgba(5, 150, 105, 0.2)',
                    borderColor: '#059669',
                    pointBackgroundColor: '#059669'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    ...tooltipPlugin
                },
                scales: {
                    r: {
                        angleLines: { color: '#e2e8f0' },
                        grid: { color: '#e2e8f0' },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });

        // --- PLOTLY 1: HIERARCHY FUNNEL ---
        const pyramidData = [{
            type: 'funnel',
            y: ["Constituição Federal", "Constituição Estadual", "Lei Orgânica (LOM)", "Leis Municipais", "Decretos e Portarias"],
            x: [100, 80, 60, 40, 20],
            textinfo: "y",
            hoverinfo: "x+y",
            marker: {
                color: ["#1e3a8a", "#1d4ed8", "#2563eb", "#059669", "#10b981"]
            }
        }];

        const pyramidLayout = {
            margin: { l: 150, r: 20, t: 20, b: 20 },
            funnelmode: "stack",
            showlegend: false,
            font: { family: 'Inter, sans-serif' }
        };

        Plotly.newPlot('pyramidDiv', pyramidData, pyramidLayout, {responsive: true, displayModeBar: false, renderer: 'canvas'});

        // --- PLOTLY 2: SCATTER PLOT (ECONOMICS) ---
        const scatterData = {
            x: [10, 25, 40, 60, 85, 95], // Índice de Liberdade Económica Municipal
            y: [15, 30, 45, 65, 80, 92], // Receita Própria (ISS/IPTU)
            mode: 'markers+lines',
            type: 'scatter',
            marker: { size: 12, color: '#eab308' },
            line: { color: '#1e3a8a', width: 2 },
            text: ['Burocracia Extrema', 'Baixa Digitalização', 'Em Transição', 'Lei Liberdade Econ.', 'Ambiente Favorável', 'Polo de Desenvolvimento'],
            hoverinfo: 'text+y'
        };

        const scatterLayout = {
            margin: { l: 60, r: 40, t: 40, b: 60 },
            xaxis: { title: 'Índice de Liberdade Económica (0-100)', showgrid: true, gridcolor: '#e2e8f0' },
            yaxis: { title: 'Arrecadação Própria (Índice)', showgrid: true, gridcolor: '#e2e8f0' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Inter, sans-serif' }
        };

        Plotly.newPlot('scatterDiv', [scatterData], scatterLayout, {responsive: true, displayModeBar: false, renderer: 'canvas'});

        // Pre-fill Leadership inputs based on the user's previous example
        document.getElementById('cityLeadership').value = 'Cacequi';
        document.getElementById('stateLeadership').value = 'RS';

        // Automatically trigger the generation function for the user's previously specified data
        // Check if the content is currently empty before calling
        window.onload = function() {
            const contentDiv = document.getElementById('leadershipContent');
            if (contentDiv && contentDiv.innerHTML.trim() === '') {
                // Ensure inputs are pre-filled before calling
                document.getElementById('cityLeadership').value = 'Cacequi';
                document.getElementById('stateLeadership').value = 'RS';
                generateLeadershipStructure();
            }
        };


    </script>
</body>
</html>